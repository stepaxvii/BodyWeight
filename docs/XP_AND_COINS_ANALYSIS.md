# –ê–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º—ã XP –∏ –ú–æ–Ω–µ—Ç

**–î–∞—Ç–∞**: 30.12.2024  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (30.12.2024)

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ Backend - –ü—Ä–∞–≤–∏–ª—å–Ω–æ

#### –§–æ—Ä–º—É–ª–∞ XP (backend/app/services/xp_calculator.py)
```python
XP = base_xp √ó difficulty_mult √ó streak_mult √ó volume_mult √ó first_bonus

difficulty_mult = 1 + (difficulty - 1) √ó 0.25  # 1.0, 1.25, 1.5, 1.75, 2.0
streak_mult = 1 + min(streak_days, 30) √ó 0.0167  # –¥–æ √ó1.5
volume_mult = 1 + reps √ó 0.02 (–µ—Å–ª–∏ reps ‚â§ 20)  # –¥–æ √ó1.4
         –∏–ª–∏ 1.4 + (reps - 20) √ó 0.01 (–µ—Å–ª–∏ reps > 20)
first_bonus = 1.2 (–ø–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è) –∏–ª–∏ 1.0
```

#### –§–æ—Ä–º—É–ª–∞ –ú–æ–Ω–µ—Ç (backend/app/services/xp_calculator.py)
```python
coins = 0

# 1. XP threshold: 1 –º–æ–Ω–µ—Ç–∞ –µ—Å–ª–∏ XP ‚â• 500
if xp_earned >= 500:
    coins += 1

# 2. Streak bonus: 1 –º–æ–Ω–µ—Ç–∞ –∑–∞ –∫–∞–∂–¥—ã–µ 7 –¥–Ω–µ–π (–º–∞–∫—Å 4 –ø—Ä–∏ 28+ –¥–Ω—è—Ö)
coins += min(streak_days // 7, 4)

# 3. Long workout: 1 –º–æ–Ω–µ—Ç–∞ –µ—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚â• 45 –º–∏–Ω—É—Ç
if workout_duration_minutes >= 45:
    coins += 1
```

#### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ú–æ–Ω–µ—Ç (backend/app/services/workout_processor.py)
1. **–ò–∑ workout**: `calculate_coins()` - –±–∞–∑–æ–≤—ã–µ –º–æ–Ω–µ—Ç—ã –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
2. **–ò–∑ achievements**: `coin_reward` –∏–∑ achievements.json (–Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –≤ `achievement_checker.py`)
3. **–ò–∑ goals**: 5 –º–æ–Ω–µ—Ç –∑–∞ –∫–∞–∂–¥—É—é –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ü–µ–ª—å
4. **–ò–∑ level up**: ‚úÖ 5 –º–æ–Ω–µ—Ç √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π (–¥–æ–±–∞–≤–ª–µ–Ω–æ)

#### –°–ø–∏—Å–∞–Ω–∏–µ –ú–æ–Ω–µ—Ç
- ‚úÖ –ú–∞–≥–∞–∑–∏–Ω: `user.coins -= item.price_coins` (shop.py:129)

---

### ‚ö†Ô∏è Frontend - –ü—Ä–æ–±–ª–µ–º—ã

#### 1. –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç XP –≤ workout store
**–§–∞–π–ª**: `frontend/mini-app/src/lib/stores/workout.svelte.ts:41-71`

**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞—Å—á—ë—Ç XP –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç:
- ‚ùå Streak multiplier
- ‚ùå First workout bonus
- ‚ùå –°—á–∏—Ç–∞–µ—Ç –ø–æ –ø–æ–¥—Ö–æ–¥–∞–º, –∞ –Ω–µ –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```typescript
// –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç - –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
total += baseXp * difficultyMult * volumeMult; // –ù–µ—Ç streak –∏ first bonus
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ backend —Ä–∞—Å—á—ë—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ —É–±—Ä–∞—Ç—å —Å–æ–≤—Å–µ–º.

#### 2. –§–æ—Ä–º—É–ª—ã –≤ xp.ts –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
**–§–∞–π–ª**: `frontend/mini-app/src/lib/utils/xp.ts`

‚úÖ –§–æ—Ä–º—É–ª—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å backend, –Ω–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –≤ workout store!

#### 3. –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
**–§–∞–π–ª**: `frontend/mini-app/src/lib/stores/user.svelte.ts:30-40`

‚úÖ –§–æ—Ä–º—É–ª–∞ —É—Ä–æ–≤–Ω—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å backend: `100 √ó (level-1)¬≤`

---

## üîß –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –£–±—Ä–∞—Ç—å —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç XP –∏–∑ workout store

**–ü—Ä–æ–±–ª–µ–º–∞**: Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π XP –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.

**–†–µ—à–µ–Ω–∏–µ**: 
- –í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –£–±—Ä–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–æ–º–µ—Ç–∫–æ–π "~" –∏ –∏–∫–æ–Ω–∫–æ–π "?"

### 2. –î–æ–±–∞–≤–∏—Ç—å –±–æ–Ω—É—Å –º–æ–Ω–µ—Ç –∑–∞ level up (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

**–í–æ–ø—Ä–æ—Å**: –î–æ–ª–∂–µ–Ω –ª–∏ –±—ã—Ç—å –±–æ–Ω—É—Å –º–æ–Ω–µ—Ç –∑–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è?

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**: –ù–µ—Ç –±–æ–Ω—É—Å–∞ –∑–∞ level up –≤ workout_processor.py

**–°—Ç–∞—Ä—ã–π –∫–æ–¥** (–±—ã–ª –≤ workouts.py):
```python
if level_up:
    level_up_bonus = (user.level - old_level) * 5
    user.coins += level_up_bonus
```

**–†–µ—à–µ–Ω–∏–µ**: –†–µ—à–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ —ç—Ç–æ—Ç –±–æ–Ω—É—Å, –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –¥–∞.

### 3. –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: –§–æ—Ä–º—É–ª—ã –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ backend –∏ frontend.

**–†–µ—à–µ–Ω–∏–µ**: 
- Backend - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ XP/–º–æ–Ω–µ—Ç
- Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞)
- –£–±—Ä–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç XP –Ω–∞ frontend

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è –º–æ–Ω–µ—Ç

**–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ**:
- ‚úÖ Workout: `calculate_coins()` –≤ workout_processor.py
- ‚úÖ Achievements: `coin_reward` –≤ achievement_checker.py
- ‚úÖ Goals: 5 –º–æ–Ω–µ—Ç –≤ workout_processor.py (_update_user_goals)
- ‚ùì Level up: –Ω–µ—Ç (–Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å)

**–°–ø–∏—Å–∞–Ω–∏–µ**:
- ‚úÖ Shop purchase: `user.coins -= item.price_coins` –≤ shop.py

---

## üìù –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º—É–ª

### XP –§–æ—Ä–º—É–ª–∞ - –ü—Ä–æ–≤–µ—Ä–∫–∞

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞**:
- base_xp = 10
- difficulty = 3 (‚òÖ‚òÖ‚òÖ)
- reps = 25
- streak_days = 7
- is_first_today = true

**–†–∞—Å—á—ë—Ç**:
```
difficulty_mult = 1 + (3-1) √ó 0.25 = 1.5
streak_mult = 1 + min(7, 30) √ó 0.0167 = 1.1169
volume_mult = 1.4 + (25-20) √ó 0.01 = 1.45
first_bonus = 1.2

XP = 10 √ó 1.5 √ó 1.1169 √ó 1.45 √ó 1.2 = 29.15 ‚Üí 29 XP
```

### –ú–æ–Ω–µ—Ç—ã –§–æ—Ä–º—É–ª–∞ - –ü—Ä–æ–≤–µ—Ä–∫–∞

**–ü—Ä–∏–º–µ—Ä—ã**:
- XP = 600, streak = 14, duration = 50 –º–∏–Ω
  - coins = 1 (XP ‚â• 500) + 2 (14//7) + 1 (‚â•45 –º–∏–Ω) = **4 –º–æ–Ω–µ—Ç—ã**

- XP = 300, streak = 21, duration = 30 –º–∏–Ω
  - coins = 0 (XP < 500) + 3 (21//7) + 0 (<45 –º–∏–Ω) = **3 –º–æ–Ω–µ—Ç—ã**

- XP = 100, streak = 5, duration = 20 –º–∏–Ω
  - coins = 0 + 0 + 0 = **0 –º–æ–Ω–µ—Ç**

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- [x] –£–±—Ä–∞—Ç—å —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç XP –∏–∑ workout store
- [x] –†–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å —Å –±–æ–Ω—É—Å–æ–º –º–æ–Ω–µ—Ç –∑–∞ level up (–¥–æ–±–∞–≤–ª–µ–Ω–æ: 5 –º–æ–Ω–µ—Ç –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å)
- [x] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –º–æ–Ω–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç –∏–∑ achievements
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ñ–æ—Ä–º—É–ª XP –∏ –º–æ–Ω–µ—Ç
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª—ã (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)

### XP
```
XP = base_xp √ó difficulty_mult √ó streak_mult √ó volume_mult √ó first_bonus

–≥–¥–µ:
- difficulty_mult = 1 + (difficulty - 1) √ó 0.25
- streak_mult = 1 + min(streak_days, 30) √ó 0.0167
- volume_mult = 1 + reps √ó 0.02 (–µ—Å–ª–∏ reps ‚â§ 20)
            –∏–ª–∏ 1.4 + (reps - 20) √ó 0.01 (–µ—Å–ª–∏ reps > 20)
- first_bonus = 1.2 (–ø–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è) –∏–ª–∏ 1.0
```

### –ú–æ–Ω–µ—Ç—ã
```
coins = 0

# 1. –ë–∞–∑–æ–≤—ã–µ –º–æ–Ω–µ—Ç—ã –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
if xp_earned >= 500:
    coins += 1

coins += min(streak_days // 7, 4)

if workout_duration_minutes >= 45:
    coins += 1

# 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:
+ coin_reward –∏–∑ achievements (–Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –≤ achievement_checker)
+ 5 –º–æ–Ω–µ—Ç –∑–∞ –∫–∞–∂–¥—É—é –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ü–µ–ª—å
+ 5 –º–æ–Ω–µ—Ç √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –∑–∞ level up
```

**–í–∞–∂–Ω–æ**: –ú–æ–Ω–µ—Ç—ã –∏–∑ achievements –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –≤ `achievement_checker.py`, –∞ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ `workout_processor.py`.

### –£—Ä–æ–≤–µ–Ω—å
```
level = 1
while xp_for_level(level + 1) <= total_xp:
    level += 1

–≥–¥–µ xp_for_level(l) = 100 √ó (l-1)¬≤
```

